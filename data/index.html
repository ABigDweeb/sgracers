<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>SG Race Leaderboard Browser</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #eee;
            margin: 0;
            padding: 10px 0 15px;
        }

        h1 {
            margin-bottom: 10px;
            font-size: 2.8em;
            text-align: center;
        }

        .container {
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #leaderboardDisplay {
            margin-top: 10px;
            font-family: monospace;
            font-size: 1em;
            line-height: 1.3;
            width: 99%;
            max-height: 74vh;
            overflow-x: auto;
            overflow-y: auto;
        }

        .leaderboard-grid {
            display: grid;
            grid-template-columns: 150px repeat(42, 1fr);
            white-space: nowrap;
            background-color: #444;
        }

        .header-cell {
            background: #333;
            padding: 0;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 4;
        }

        .map-header {
            background: #252525;
            grid-column: span 3;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            border-right: 1px solid #444;
        }

        .difficulty-header {
            background: #2a2a2a;
            text-align: center;
            position: sticky;
            top: 30px;
            z-index: 2;
            font-size: 1em;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
        }

        .player-cell {
            background: #222;
            padding: 0;
            text-align: center;
            font-size: 0.9em;
            height: 30px;
            line-height: 30px;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
        }

        .player-name-header {
            background: #333;
            padding: 0 4px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 5;
            height: 60px;
            grid-row: span 2;
            display: flex;
            align-items: center;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
            border-left: 1px solid #444;
        }

        .player-name {
            background: #1a1a1a;
            padding: 0 4px;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 1;
            height: 30px;
            line-height: 30px;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
            border-left: 1px solid #444;
        }

        .player-name a {
            color: inherit;
            text-decoration: none;
        }

        .player-name a:hover {
            text-decoration: underline;
        }

        .first-place {
            color: gold;
            background: #614a00;
        }

        .second-place {
            color: #c7c7c7;
            background: #8a8a8a;
        }

        .third-place {
            color: #cd7f32;
            background: #453113;
        }

        .top5 {
            color: #cefde7;
            background: #51b78a;
        }

        .top10 {
            color: #a0d6f7;
            background: #5186a5;
        }

        .loading {
            color: #0bf;
            font-style: italic;
        }

        .error {
            color: #f55;
        }

        .entry-count {
            margin-top: 10px;
            font-size: 0.8em;
            color: #888;
        }

        #filterControls {
            margin: 5px 0 10px;
            padding: 8px;
            background: #222;
            border-radius: 5px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #filterControls label {
            color: #ddd;
            cursor: pointer;
        }

        #filterControls input[type="radio"] {
            margin-right: 5px;
        }

        .dev-box {
            position: fixed;
            bottom: 15px;
            right: 15px;
            color: #aaa;
            font-size: 0.85em;
            text-align: right;
            line-height: 1.4;
            background: rgba(30, 30, 30, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        .dev-box a {
            color: inherit;
            text-decoration: none;
        }

        .dev-box a:hover {
            text-decoration: underline;
        }

        .discord-logo {
            height: 16px;
            width: 21px;
            vertical-align: middle;
            margin-right: 4px;
        }

        .burger-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .burger-icon {
            width: 40px;
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            padding: 5px;
        }

        .burger-line {
            height: 4px;
            width: 100%;
            background-color: #eee;
            border-radius: 2px;
        }

        .menu-dropdown {
            position: absolute;
            top: 50px;
            left: 0;
            background: #222;
            border: 1px solid #444;
            border-radius: 5px;
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        .menu-dropdown.show {
            display: flex;
        }

        .menu-item {
            padding: 12px 20px;
            color: #eee;
            text-decoration: none;
            font-size: 1.05em;
            transition: background-color .2s;
        }

        .menu-item:hover {
            background: #333;
        }

        .view-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #222;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #444;
            z-index: 100;
        }

        .view-toggle span {
            color: #ddd;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #5186a5;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #51b78a;
        }

        input:checked+.slider:before {
            transform: translateX(36px);
        }

        .slider-text {
            position: absolute;
            top: 4px;
            font-size: 0.7em;
            color: white;
            font-weight: bold;
        }

        .slider-text.pos {
            left: 8px;
        }

        .slider-text.time {
            right: 8px;
        }
    </style>
</head>

<body>
    <div class="burger-menu">
        <div class="burger-icon" id="burgerIcon">
            <div class="burger-line"></div>
            <div class="burger-line"></div>
            <div class="burger-line"></div>
        </div>
        <div class="menu-dropdown" id="menuDropdown">
            <a href="/" class="menu-item">Leaderboard View</a>
            <a href="/stats" class="menu-item">Player Stats</a>
            <a href="/wrs" class="menu-item">World Records</a>
            <a href="/data/evaluation" class="menu-item">Top Racer Evaluation</a>
            <a href="/racepicker" class="menu-item">Random Race Picker</a>
            <a href="/data" class="menu-item">Spreadsheet Data</a>
            <a href="/how-to" class="menu-item">How To Connect</a>
        </div>
    </div>

    <div class="view-toggle">
        <span>Positions</span>
        <label class="switch">
            <input type="checkbox" id="viewToggle">
            <span class="slider"></span>
        </label>
        <span>Times</span>
    </div>

    <div class="container">
        <h1>Data Spreadsheet - <span id="viewType">Positions</span></h1>

        <div id="filterControls">
            <label>
                <input type="radio" name="filter" value="all" checked> Show all players
            </label>
            <label>
                <input type="radio" name="filter" value="completed"> Only all races completed
            </label>
            <label>
                <input type="radio" name="filter" value="top10"> Only has a top 10
            </label>
            <label>
                <input type="radio" name="filter" value="topracers"> Top racer view
            </label>
        </div>
        <div id="leaderboardDisplay">Loading all leaderboard data...</div>
        <div id="entryCount" class="entry-count"></div>
    </div>

    <div class="dev-box">
        <a href="https://discord.gg/YgGdSM3yC4" target="_blank">
            <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a6a49cf127bf92de1e2_icon_clyde_blurple_RGB.png" class="discord-logo" alt="Discord"></a> v1.0.0<br>
        <a href="https://x.com/ABigDweeb" target="_blank">made by Dweeb</a>
    </div>

    <script>
        const maps = [
            "Abyss", "Atlantis", "Crag", "Foregone_Destruction", "Helix",
            "Highwind", "Impact", "Karman_Station", "Lavawell", "Oasis",
            "Olympus", "Pantheon", "Silo", "Stadium"
        ];
        const difficulties = ["Easy", "Medium", "Hard"];
        const topRacers = [
            "Alfa", "blueski", "Brayden", "chikken0", "Dweeb",
            "e x m p l", "headjakk", "JalenMans", "pc", "Pickle12", 
            "Shwellsie", "SkrubW", "Toby Repellant", "void"
        ];
        const leaderboardDisplay = document.getElementById('leaderboardDisplay');
        const entryCountDisplay = document.getElementById('entryCount');
        const burgerIcon = document.getElementById('burgerIcon');
        const menuDropdown = document.getElementById('menuDropdown');
        const viewToggle = document.getElementById('viewToggle');
        const viewType = document.getElementById('viewType');

        let allLeaderboards = {};
        let allPlayersData = [];
        let totalRaces = 0;
        let totalPlayers = 0;
        let currentFilter = 'all';
        let showTimes = false;

        burgerIcon.addEventListener('click', function() {
            menuDropdown.classList.toggle('show');
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.burger-menu')) {
                menuDropdown.classList.remove('show');
            }
        });

        viewToggle.addEventListener('change', function() {
            showTimes = this.checked;
            viewType.textContent = showTimes ? 'Times' : 'Positions';

            updateView(currentFilter);
        });

        filterControls.addEventListener('change', function(e) {
            if (e.target.name === 'filter') {
                currentFilter = e.target.value;

                if (showTimes) {
                    timesFilter = currentFilter;
                } else {
                    positionsFilter = currentFilter;
                }

                updateView(currentFilter);
            }
        });

        function getMapDisplayName(map) {
            if (map === "Foregone_Destruction") return "Foregone";
            if (map === "Karman_Station") return "Karman";
            if (map === "Silo") return "Club Silo";
            return map;
        }

        function formatPlayerName(name) {
            return name.length > 20 ? name.substring(0, 17) + '...' : name;
        }

        function formatTime(ms) {
            if (!ms) return '-';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = ms % 1000;

            if (minutes > 0) {
                return `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
            } else {
                return `${seconds}.${milliseconds.toString().padStart(3, '0')}`;
            }
        }

        async function loadAllLeaderboards() {
            leaderboardDisplay.innerHTML = "Loading all leaderboards...";
            leaderboardDisplay.className = "loading";
            entryCountDisplay.textContent = '';
            totalRaces = maps.length * difficulties.length;

            try {
                const leaderboardsArray = maps.flatMap(map =>
                    difficulties.map(diff => ({
                        map,
                        difficulty: diff,
                        length: 'all'
                    }))
                );

                const response = await fetch(`/api/generate-leaderboard`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        leaderboards: leaderboardsArray
                    })
                });

                if (!response.ok) throw new Error(`Failed to load leaderboard data`);

                const data = await response.json();
                allLeaderboards = parseLeaderboards(data);

                processPlayerData();
                updateView('all');
            } catch (error) {
                leaderboardDisplay.innerHTML = `Error: ${error.message}`;
                leaderboardDisplay.className = "error";
                entryCountDisplay.textContent = '';
            }
        }

        function parseLeaderboards(rawData) {
            const structured = {};
            
            Object.entries(rawData).forEach(([mapName, difficulties]) => {
                Object.entries(difficulties || {}).forEach(([difficulty, entries]) => {
                    if (!structured[mapName]) structured[mapName] = {};
                    
                    structured[mapName][difficulty] = entries.map((entry, index) => ({
                        rank: index + 1,
                        displayName: entry.displayName || entry.compositeUserId?.platformId || "Unknown",
                        platformId: entry.compositeUserId?.platformId || null,
                        value: entry.value
                    }));
                });
            });
            
            return structured;
        }

        function processPlayerData() {
            const players = new Set();
            const playerStats = {};

            maps.forEach(map => {
                difficulties.forEach(difficulty => {
                    const leaderboard = (allLeaderboards[map] && allLeaderboards[map][difficulty]) || [];
                    leaderboard.forEach((entry, index) => {
                        if (entry) {
                            const playerName = entry.displayName || entry.name || "Unknown Player";
                            players.add(playerName);
                            if (!playerStats[playerName]) {
                                playerStats[playerName] = {
                                    completed: 0,
                                    top10: 0,
                                    times: {},
                                    positions: {}
                                };
                            }
                            playerStats[playerName].completed++;
                            if (index < 10) playerStats[playerName].top10++;
                            playerStats[playerName].times[`${map}_${difficulty}`] = entry.value;
                            playerStats[playerName].positions[`${map}_${difficulty}`] = index + 1;
                        }
                    });
                });
            });

            allPlayersData = Array.from(players).map(player => ({
                name: player,
                displayName: formatPlayerName(player),
                completedAll: playerStats[player].completed === totalRaces,
                hasTop10: playerStats[player].top10 > 0,
                isTopRacer: topRacers.includes(player),
                stats: playerStats[player]
            }));

            totalPlayers = allPlayersData.length;

            document.querySelectorAll('#filterControls input[name="filter"]').forEach(radio => {
                radio.addEventListener('change', (e) => updateView(e.target.value));
            });
        }

        function updateView(filterType) {
            currentFilter = filterType;
            let filteredPlayers = allPlayersData;

            if (filterType === 'completed') {
                filteredPlayers = allPlayersData.filter(p => p.completedAll);
            } else if (filterType === 'top10') {
                filteredPlayers = allPlayersData.filter(p => p.hasTop10);
            } else if (filterType === 'topracers') {
                filteredPlayers = allPlayersData.filter(p => p.isTopRacer);
            }

            generateGrid(filteredPlayers);
        }

        function generateGrid(playersData = allPlayersData) {
            const sortedPlayers = playersData
                .map(p => p.name)
                .sort((a, b) => a.localeCompare(b));

            let html = '<div class="leaderboard-grid">';

            html += '<div class="player-name-header">Player</div>';

            maps.forEach(map => {
                html += `<div class="map-header">${getMapDisplayName(map)}</div>`;
            });

            maps.forEach(map => {
                difficulties.forEach(difficulty => {
                    html += `<div class="difficulty-header">${difficulty === 'Medium' ? 'Med' : difficulty}</div>`;
                });
            });

            sortedPlayers.forEach(player => {
                const playerData = allPlayersData.find(p => p.name === player);
                html += `<div class="player-name"><a href="/stats?player=${encodeURIComponent(playerData.name)}">${playerData.displayName}</a></div>`;

                maps.forEach(map => {
                    difficulties.forEach(difficulty => {
                        const key = `${map}_${difficulty}`;
                        const position = playerData.stats.positions[key];

                        if (!position) {
                            html += '<div class="player-cell">-</div>';
                            return;
                        }

                        let cellClass = "player-cell";
                        if (position === 1) cellClass += " first-place";
                        else if (position === 2) cellClass += " second-place";
                        else if (position === 3) cellClass += " third-place";
                        else if (position <= 5) cellClass += " top5";
                        else if (position <= 10) cellClass += " top10";

                        if (showTimes) {
                            const time = playerData.stats.times[key];
                            html += `<div class="${cellClass}">${formatTime(time)}</div>`;
                        } else {
                            html += `<div class="${cellClass}">${position}</div>`;
                        }
                    });
                });
            });

            html += '</div>';
            leaderboardDisplay.innerHTML = html;
            leaderboardDisplay.className = "";

            entryCountDisplay.textContent = `Showing ${sortedPlayers.length} entries of ${totalPlayers} total players`;
        }

        function init() {
            loadAllLeaderboards();
        }

        init();
    </script>
</body>

</html>