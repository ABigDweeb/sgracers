<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Individual Lookup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #111; 
      color: #eee; 
      margin: 0; 
      padding: 10px 0 15px;
    }
    h1 { 
      margin-bottom: 10px;
      font-size: 2.8em; 
      text-align: center;
    }
    .container { 
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1400px;
    }
    #playerLookup {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #playerInput {
      padding: 10px 15px;
      font-size: 1.2em;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 5px;
      min-width: 300px;
    }
    #lookupButton {
      padding: 10px 20px;
      background: #444;
      color: #eee;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: pointer;
    }
    #lookupButton:hover {
      background: #555;
    }
    .stats-table {
      width: 100%;
      margin-bottom: 20px;
      border-collapse: collapse;
      background-color: #444;
    }
    .stats-table th, .stats-table td {
      padding: 10px;
      text-align: center;
      border: 1px solid #555;
    }
    .stats-table th {
      background: #333;
      font-weight: bold;
    }
    .stats-table td {
      background: #252525;
    }
    .stats-table td.forty-two {
      background: #2a5a2a !important;
      color: #0f0;
    }
    .tables-container {
      display: flex;
      gap: 20px;
      width: 100%;
    }
    .table-wrapper {
      flex: 1;
      overflow-x: auto;
    }
    .results-table {
      font-family: monospace;
      font-size: 1em;
      width: 100%;
      border-collapse: collapse;
      background-color: #444;
    }
    .results-table th {
      background: #333;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 4;
      border-right: 1px solid #444; 
      border-top: 1px solid #444; 
    }
    .results-table td {
      padding: 10px;
      border: 1px solid #555;
    }
    .map-cell {
      background: #252525;
      text-align: left;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 3;
    }
    .position-cell, .time-cell {
      text-align: center;
    }
    .position-cell.not-found, .time-cell.not-found {
      color: #f55;
      background: #3a2525;
    }
    .dnf-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #3a2525;
      color: #f55;
      padding: 15px;
      border: 1px solid #f55;
      border-radius: 5px;
      max-width: 400px;
      display: none;
      z-index: 100;
    }
    .dnf-notification a {
      color: #f88;
      text-decoration: underline;
    }
    .dnf-notification a:hover {
      color: #faa;
    }
    .first-place {
      color: gold;
      background: #614a00;
    }
    .second-place {
      color: #c7c7c7;
      background: #8a8a8a;
    }
    .third-place {
      color: #cd7f32;
      background: #453113;
    }
    .top5 {
      color: #cefde7;
      background: #51b78a;
    }
    .top10 {
      color: #a0d6f7;
      background: #5186a5;
    }
    .totals-row {
      font-weight: bold;
      background: #2a2a2a;
    }
    .loading { 
      color: #0bf; 
      font-style: italic; 
    }
    .error { 
      color: #f55;
    }
    .not-found {
      color: #888;
      font-style: italic;
    }
    .dev-box {
      position: fixed;
      bottom: 15px;
      right: 15px;
      color: #aaa;
      font-size: 0.85em;
      text-align: right;
      line-height: 1.4;
      background: rgba(30, 30, 30, 0.8);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #444;
    }
    .dev-box a {
      color: inherit;
      text-decoration: none;
    }
    .dev-box a:hover {
      text-decoration: underline;
    }
    .discord-logo {
      height: 16px;
      width: 21px;
      vertical-align: middle;
      margin-right: 4px;
    }
    .burger-menu {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
    }
    .burger-icon {
      width: 40px;
      height: 30px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      padding: 5px;
    }
    .burger-line {
      height: 4px;
      width: 100%;
      background-color: #eee;
      border-radius: 2px;
    }
    .menu-dropdown {
      position: absolute;
      top: 50px;
      left: 0;
      background: #222;
      border: 1px solid #444;
      border-radius: 5px;
      min-width: 200px;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .menu-dropdown.show {
      display: flex;
    }
    .menu-item {
      padding: 12px 20px;
      color: #eee;
      text-decoration: none;
      font-size: 1.2em;
      transition: background-color 0.2s;
    }
    .menu-item:hover {
      background-color: #333;
    }
  </style>
</head>
<body>
  <div class="burger-menu">
    <div class="burger-icon" id="burgerIcon">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="menu-dropdown" id="menuDropdown">
      <a href="/" class="menu-item">Leaderboard View</a>
      <a href="/data/times" class="menu-item">Times Spreadsheet</a>
      <a href="/data/positions" class="menu-item">Positions Spreadsheet</a>
      <a href="/data/individual" class="menu-item">Individual Lookup</a>
      <a href="/wrs" class="menu-item">World Records</a>
      <a href="/data/evaluation" class="menu-item">Top Racer Evaluation</a>
    </div>
  </div>

  <div class="dnf-notification" id="dnfNotification">
    note: DNF times are races you have not yet completed. for individual stats, they are not accounted for in the totals or averages. for the <a href="/data/evaluation">top racer evaluation</a>  however, each DNF is defaulted to a 2m time and 200th place.
  </div>
  
  <div class="container">
    <h1>Player Lookup</h1>
    
    <div id="playerLookup">
      <input type="text" id="playerInput" placeholder="Enter username">
      <button id="lookupButton">Search</button>
    </div>
    
    <div id="resultsDisplay" style="display: none;"></div>
    
    <table class="stats-table" id="statsTable" style="display: none;">
      <thead>
        <tr>
          <th>T10</th>
          <th>T5</th>
          <th>T3</th>
          <th>WR</th>
          <th>Total Position</th>
          <th>Avg Position</th>
          <th>Total Time</th>
          <th>Avg Time</th>
        </tr>
      </thead>
      <tbody id="statsBody">

      </tbody>
    </table>
    
    <div class="tables-container" id="tablesContainer" style="display: none;">
      <div class="table-wrapper">
        <table class="results-table" id="positionsTable">
          <thead>
            <tr>
              <th>Map</th>
              <th>Easy</th>
              <th>Med</th>
              <th>Hard</th>
            </tr>
          </thead>
          <tbody id="positionsBody">

          </tbody>
          <tfoot id="positionsFooter">

          </tfoot>
        </table>
      </div>
      
      <div class="table-wrapper">
        <table class="results-table" id="timesTable">
          <thead>
            <tr>
              <th>Map</th>
              <th>Easy</th>
              <th>Med</th>
              <th>Hard</th>
            </tr>
          </thead>
          <tbody id="timesBody">

          </tbody>
          <tfoot id="timesFooter">

          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="dev-box">
    <a href="https://discord.gg/YgGdSM3yC4" target="_blank"> 
    <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a6a49cf127bf92de1e2_icon_clyde_blurple_RGB.png" class="discord-logo" alt="Discord"></a> v0.3.0<br>
    <a href="https://x.com/ABigDweeb" target="_blank">made by Dweeb</a>
  </div>

  <script>
    const maps = [
      "Abyss", "Atlantis", "Crag", "Foregone_Destruction", "Helix",
      "Highwind", "Impact", "Karman_Station", "Lavawell", "Oasis",
      "Olympus", "Pantheon", "Silo", "Stadium"
    ];
    const difficulties = ["Easy", "Med", "Hard"];
    
    const playerInput = document.getElementById('playerInput');
    const lookupButton = document.getElementById('lookupButton');
    const resultsDisplay = document.getElementById('resultsDisplay');
    const statsTable = document.getElementById('statsTable');
    const statsBody = document.getElementById('statsBody');
    const tablesContainer = document.getElementById('tablesContainer');
    const positionsBody = document.getElementById('positionsBody');
    const positionsFooter = document.getElementById('positionsFooter');
    const timesBody = document.getElementById('timesBody');
    const timesFooter = document.getElementById('timesFooter');
    const burgerIcon = document.getElementById('burgerIcon');
    const menuDropdown = document.getElementById('menuDropdown');
    
    let allLeaderboards = {};

    burgerIcon.addEventListener('click', function() {
      menuDropdown.classList.toggle('show');
    });

    document.addEventListener('click', function(event) {
      if (!event.target.closest('.burger-menu')) {
        menuDropdown.classList.remove('show');
      }
    });

    playerInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        lookupPlayer();
      }
    });

    lookupButton.addEventListener('click', lookupPlayer);

    function formatMapName(map) {
      let formatted = map.replace(/_/g, ' ');
      if (formatted === "Silo") return "Club Silo";
      return formatted;
    }

    function formatTime(ms) {
      if (ms === null) return 'DNF';
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      const milliseconds = Math.floor(ms % 1000);
      
      if (minutes > 0) {
        return `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
      } else {
        return `${seconds}.${milliseconds.toString().padStart(3, '0')}`;
      }
    }

    function getPositionClass(position) {
      if (position === null) return '';
      if (position === 1) return 'first-place';
      if (position === 2) return 'second-place';
      if (position === 3) return 'third-place';
      if (position <= 5) return 'top5';
      if (position <= 10) return 'top10';
      return '';
    }

    async function loadAllLeaderboards() {
      resultsDisplay.innerHTML = "Loading all leaderboards...";
      resultsDisplay.className = "loading";
      resultsDisplay.style.display = "block";
      
      try {
        const leaderboardPromises = maps.flatMap(map => 
          difficulties.map(async difficulty => {
            try {
              const filename = `${map}_${difficulty === 'Med' ? 'Medium' : difficulty}.json`;
              const response = await fetch(`/leaderboards/${filename}`);
              if (!response.ok) return { map, difficulty, data: null };
              const data = await response.json();
              return { map, difficulty, data };
            } catch (e) {
              return { map, difficulty, data: null };
            }
          })
        );
        
        const results = await Promise.all(leaderboardPromises);
        
        allLeaderboards = {};
        results.forEach(({ map, difficulty, data }) => {
          if (!allLeaderboards[map]) allLeaderboards[map] = {};
          allLeaderboards[map][difficulty] = (data && (data.leaderboard || data)) || [];
        });
        
        resultsDisplay.style.display = "none";
      } catch (error) {
        resultsDisplay.innerHTML = `Error: ${error.message}`;
        resultsDisplay.className = "error";
      }
    }

    function lookupPlayer() {
      const playerName = playerInput.value.trim();
      if (!playerName) return;
      
      resultsDisplay.innerHTML = "Searching...";
      resultsDisplay.className = "loading";
      resultsDisplay.style.display = "block";
      statsTable.style.display = "none";
      tablesContainer.style.display = "none";
      document.getElementById('dnfNotification').style.display = "none";
      
      let playerFound = false;
      let playerData = {};
      let stats = {
        t10: 0,
        t5: 0,
        t3: 0,
        wr: 0,
        totalPosition: 0,
        totalTime: 0,
        completedRaces: 0,
        missingRaces: 0
      };
      
      let difficultyStats = {
        positions: {
          Easy: { sum: 0, count: 0, missing: 0 },
          Med: { sum: 0, count: 0, missing: 0 },
          Hard: { sum: 0, count: 0, missing: 0 }
        },
        times: {
          Easy: { sum: 0, count: 0, missing: 0 },
          Med: { sum: 0, count: 0, missing: 0 },
          Hard: { sum: 0, count: 0, missing: 0 }
        }
      };
      
      maps.forEach(map => {
        playerData[map] = {};
        difficulties.forEach(difficulty => {
          const leaderboard = (allLeaderboards[map] && allLeaderboards[map][difficulty]) || [];
          const entry = leaderboard.find(e => 
            (e.displayName && e.displayName.toLowerCase() === playerName.toLowerCase()) || 
            (e.name && e.name.toLowerCase() === playerName.toLowerCase())
          );
          
          if (entry) {
            playerFound = true;
            const position = leaderboard.indexOf(entry) + 1;
            const time = entry.value;
            
            playerData[map][difficulty] = {
              position,
              time,
              isFound: true
            };
              
            if (position) {
              stats.completedRaces++;
              stats.totalPosition += position;
              difficultyStats.positions[difficulty].sum += position;
              difficultyStats.positions[difficulty].count++;
              
              if (position <= 10) stats.t10++;
              if (position <= 5) stats.t5++;
              if (position <= 3) stats.t3++;
              if (position === 1) stats.wr++;
            }
            if (time) {
              stats.totalTime += time;
              difficultyStats.times[difficulty].sum += time;
              difficultyStats.times[difficulty].count++;
            }
          } else {
            playerData[map][difficulty] = {
              position: null,
              time: null,
              isFound: false
            };
            stats.missingRaces++;
            difficultyStats.positions[difficulty].missing++;
            difficultyStats.times[difficulty].missing++;
          }
        });
      });
      
      if (!playerFound) {
        resultsDisplay.innerHTML = `Player "${playerName}" not found in any leaderboards`;
        resultsDisplay.className = "not-found";
        return;
      }
      if (stats.missingRaces > 0) {
        document.getElementById('dnfNotification').style.display = "block";
      }
      
      const avgPosition = stats.completedRaces > 0 ? stats.totalPosition / stats.completedRaces : 0;
      const avgTime = stats.completedRaces > 0 ? stats.totalTime / stats.completedRaces : 0;
      
      const easyAvgPos = difficultyStats.positions.Easy.count > 0 ? difficultyStats.positions.Easy.sum / difficultyStats.positions.Easy.count : 0;
      const medAvgPos = difficultyStats.positions.Med.count > 0 ? difficultyStats.positions.Med.sum / difficultyStats.positions.Med.count : 0;
      const hardAvgPos = difficultyStats.positions.Hard.count > 0 ? difficultyStats.positions.Hard.sum / difficultyStats.positions.Hard.count : 0;
      
      const easyAvgTime = difficultyStats.times.Easy.count > 0 ? difficultyStats.times.Easy.sum / difficultyStats.times.Easy.count : 0;
      const medAvgTime = difficultyStats.times.Med.count > 0 ? difficultyStats.times.Med.sum / difficultyStats.times.Med.count : 0;
      const hardAvgTime = difficultyStats.times.Hard.count > 0 ? difficultyStats.times.Hard.sum / difficultyStats.times.Hard.count : 0;
      
      statsBody.innerHTML = `
        <tr>
          <td class="${stats.t10 === 42 ? 'forty-two' : ''}">${stats.t10}</td>
          <td class="${stats.t5 === 42 ? 'forty-two' : ''}">${stats.t5}</td>
          <td class="${stats.t3 === 42 ? 'forty-two' : ''}">${stats.t3}</td>
          <td class="${stats.wr === 42 ? 'forty-two' : ''}">${stats.wr}</td>
          <td>${stats.totalPosition}</td>
          <td>${avgPosition.toFixed(2)}</td>
          <td>${formatTime(stats.totalTime)}</td>
          <td>${formatTime(avgTime)}</td>
        </tr>
      `;
      
      let positionsHTML = '';
      let timesHTML = '';
      
      maps.forEach(map => {
        positionsHTML += `<tr><td class="map-cell">${formatMapName(map)}</td>`;
        timesHTML += `<tr><td class="map-cell">${formatMapName(map)}</td>`;
        
        difficulties.forEach(difficulty => {
          const entry = playerData[map][difficulty];
          
          if (!entry.isFound) {
            positionsHTML += '<td class="position-cell not-found">DNF</td>';
            timesHTML += '<td class="time-cell not-found">DNF</td>';
          } else {
            const positionClass = getPositionClass(entry.position);
            const positionDisplay = entry.position;
            const timeValue = formatTime(entry.time);
            positionsHTML += `<td class="position-cell ${positionClass}">${positionDisplay}</td>`;
            timesHTML += `<td class="time-cell ${positionClass}">${timeValue}</td>`;
          }
        });
        
        positionsHTML += '</tr>';
        timesHTML += '</tr>';
      });
      
      positionsBody.innerHTML = positionsHTML;
      timesBody.innerHTML = timesHTML;
      
      positionsFooter.innerHTML = `
        <tr class="totals-row">
          <td class="map-cell">Total Position</td>
          <td class="position-cell">${difficultyStats.positions.Easy.sum}</td>
          <td class="position-cell">${difficultyStats.positions.Med.sum}</td>
          <td class="position-cell">${difficultyStats.positions.Hard.sum}</td>
        </tr>
        <tr class="totals-row">
          <td class="map-cell">Average Position</td>
          <td class="position-cell">${easyAvgPos.toFixed(2)}</td>
          <td class="position-cell">${medAvgPos.toFixed(2)}</td>
          <td class="position-cell">${hardAvgPos.toFixed(2)}</td>
        </tr>
      `;
      
      timesFooter.innerHTML = `
        <tr class="totals-row">
          <td class="map-cell">Total Time</td>
          <td class="time-cell">${formatTime(difficultyStats.times.Easy.sum)}</td>
          <td class="time-cell">${formatTime(difficultyStats.times.Med.sum)}</td>
          <td class="time-cell">${formatTime(difficultyStats.times.Hard.sum)}</td>
        </tr>
        <tr class="totals-row">
          <td class="map-cell">Average Time</td>
          <td class="time-cell">${formatTime(easyAvgTime)}</td>
          <td class="time-cell">${formatTime(medAvgTime)}</td>
          <td class="time-cell">${formatTime(hardAvgTime)}</td>
        </tr>
      `;
      
      resultsDisplay.style.display = "none";
      statsTable.style.display = "table";
      tablesContainer.style.display = "flex";
    }

    function init() {
      loadAllLeaderboards();
    }

    init();
  </script>
</body>

</html>